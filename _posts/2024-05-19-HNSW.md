---
layout: single
title:  "HNSW"
categories: VectorDB
tag: [database, algorithm]
toc: true
toc_sticky: true
author_profile: true
---

# Hierarchical Navigable Small World
## About Paper
- 제목: Efficient and robust approximate nearest neighbor search using Hierarchical Navigable Small World grpahs
- 저널: IEEE Transactions on pattern analysis and machine intelligence. 2018.
- 저자: Yu. A. Malkov, D. A. Yashunin

## Preliminary Knowledge
- [Vector Database](https://meongju0o0.github.io/vectordb/vectorDB/)
- [k Nearest Neighbors](https://meongju0o0.github.io/vectordb/traditional_knn/)

## Delaunay triangulation(들로네 삼각분할)
- 들로네 삼각분할
- 평면 위 점들을 삼각형으로 연결하여 공간을 분할할 때, 이 삼각형들의 내각의 최소값이 최대가 되도록 하는 분할
<p align="center">
    <img src="/images/2024-05-19-HNSW/delaunay_triangulation.png"/>
</p>

- 들로네 삼각분할은 (c)가 아닌 (b)와 같은 모양이 나오게끔 그래프를 구축하는 알고리즘
- 위 들로네 삼각분할의 가장 중용한 특징은 아래와 같음
    - 어떤 삼각형의 외접원도 그 삼각형의 세 꼭지점을 제외한 다른 어떤 점도 포함하지 않는다
    - 이를 empty circumcircle property라고 함
<p align="center">
    <img src="/images/2024-05-19-HNSW/circumcircle.png" width="256"/>
</p>

- kNN Index 중 Delaunay Graph가 한때 사용되곤 했음

## probabilistic skip list
- linked list를 개선한 자료구조
- linked list의 가장 큰 단점이 random access가 불가능하다는 것이다
    - 위 단점으로 인해 Sorted List마저 탐색 시간복잡도가 $O(n)$이 된다
- 위 단점을 극복하고자 일부 노드는 한번에 여러 칸을 건너뛸 수 있도록 설계(skip)
- 이때, 노드의 포인터 개수는 확률적으로 정해짐(probabilistic)

![skip_list](/images/2024-05-19-HNSW/skip_list.png)

## Small World
- Regular Graph에서 일부 에지를 삭제한 후 무작위로 연결한 그래프
- Regular Graph에 비해 특정 지점으로 이동하는데 필요한 distance 감소

- Algorithm
    - 평균 차수가 2K인 N개 노드를 갖는 링 모양 격자 생성
    - 각 노드는 양쪽으로 K개의 최근접 이웃 노드에 연결
    - 그래프의 각 간선에 대해 확룔 $\beta$ 를 사용하여 타깃 노드를 재연결
    - 재연결된 간선은 중복 간선이거나 자가 루프일 수 없음
<p align="center">
    <img src="/images/2024-05-19-HNSW/small_world_graph.png"/>
</p>

- 이점
    - regular graph에서 두 노드를 선택했을 때, 이동 거리(즉, 그래프 탐색 횟수)에 비해 small world graph는 확연히 줄어듬
    - 일부 노드를 재연결하여 먼 거리의 노드를 연결하였기 때문

## Navigable Small World
### Navigable Small World Introduction
- Nearest Neighbor Index 구축 시, graph를 생성하는 이유
    - 근접하는 이웃 기리 에지를 생성하여 query point의 neighbor 만을 탐색
    - 그래프 이동 경로를 따라 최근접 이웃을 탐색하므로 탐색 범위 축소
        - 그래프 이동 경로의 1-hop neighbor들 만을 탐색
- naive idea로 최근접 이웃끼리 에지를 생성한다고 해보자
<p align="center">
    <img src="/images/2024-05-19-HNSW/select_neighbor_simple.png" width="512"/>
</p>

- 위 그림과 같이 탐색이 불가능한 노드 발생: **candidate3**

- 이에 본 논문에서는 heuristic algorithm을 사용하라고 제안
<p align="center">
    <img src="/images/2024-05-19-HNSW/select_neighbor_heuristic.png" width="384"/>
</p>

### Navigable Small World Algorithm
<ol>
    <li>처음에는 가장 가까운 이웃을 선택하여 에지 생성</li>
    <p align="center">
        <img src="/images/2024-05-19-HNSW/nsw_algo1.png" width="384"/>
    </p>
    <li>새로 연결될 candidate는 기존에 연결된 candidate와 새로 연결될 candidate사이의 거리보다 멀어야 함</li>
    <ul>
        <li>새로 연결될 candidate: candidate2, candidate3</li>
        <li>기존에 연결된 candidate: candidate1</li>
        <li>즉, candidate1과 candidate2사이의 거리는 enterpoint와 candidate2 사이의 거리보다 가까우므로 연결이 되지 않음</li>
        <li>한편, candidate1와 candidate3사이의 거리는 enterpoint와 candidate3 사이의 거리보다 멀으므로 연결이 가능함</li>
    </ul>
    <p align="center">
        <img src="/images/2024-05-19-HNSW/nsw_algo2.png" width="384"/>
    </p>
    <ul>
        <li>위 그림에서 노란색 배경으로 처리된 부분이 노드를 추가할 수 없는 부분</li>
        <li>반대로 하얀색 배경은 노드를 추가할 수 있는 부분</li>
    </ul>
    <li>enterpoint를 변경하여 위 두 과정 반복</li>
    <p align="center">
        <img src="/images/2024-05-19-HNSW/nsw_algo3.png" width="320"/>
        <img src="/images/2024-05-19-HNSW/nsw_algo4.png" width="320"/>
    </p>
    <p align="center">
        <img src="/images/2024-05-19-HNSW/nsw_algo5.png" width="320"/>
        <img src="/images/2024-05-19-HNSW/nsw_algo6.png" width="320"/>
    </p>
    <p align="center">
        <img src="/images/2024-05-19-HNSW/nsw_algo7.png" width="320"/>
        <img src="/images/2024-05-19-HNSW/nsw_algo8.png" width="320"/>
    </p>
    <p align="center">
        <img src="/images/2024-05-19-HNSW/nsw_algo9.png" width="384"/>
    </p>
</ol>

### Navigable Small World Graph
- 위 과정은 Regular Graph를 형성하는 과정
- 위 그래프에서 일부 에지를 재연결함으로서 Navigable Small World Graph가 완성됨
<p align="center">
    <img src="/images/2024-05-19-HNSW/nswg.png"/>
</p>

- 빨간색 에지가 재연결된 에지
- 화살표가 있는 에지가 탐색 경로

- Navgable Small World Graph의 가장 큰 단점은 local minimum에 빠지는 경우가 많다는 것이다.
- 즉, 비록 같은 Approximate Nearest Neighbor Algorithm이지만 더 정확한 Nearest Neighbor를 찾고싶은 것이 Hierarchical Navigable Small World의 등장 배경이다.

## Hierarchical Navigable Small World
### Motivation
- NSW Graph의 local minimum 문제 해결
- probabilistic skip list의 아이디어에서 창안해 확률적으로 일부 노드를 샘플링하여 여러 계층의 그래프를 구축

### Introduction
<p align="center">
    <img src="/images/2024-05-19-HNSW/hnsw.webp" width = "704"/>
</p>

- 계층적으로 NSW를 구축하여 Nearest Neighbor 탐색
- NSW 그래프에서 삭제되는 에지가 없으므로 ANN Search의 Recall 보존
- 상위 계층에서 한번에 많이 이동하여 Time Efficiency 개선
    - 여러 계층에 걸쳐 NSW를 구축
    - 상위 계층에서는 entry point에서 한번에 멀리 이동하면서 Nearest Neighbor 탐색
    - 하위 계층에서는 정확도를 보장하기 위해 조금씩 이동하면서 Nearest Neighbor 탐색
- 최상위 계층의 노드는 무작위로 추출
    - 추출된 노드를 활용하여 위 NSW Graph 구축